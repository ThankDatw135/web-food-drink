<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý Sản phẩm - Admin</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .admin-container {
        display: flex;
        min-height: 100vh;
      }
      .sidebar {
        width: 250px;
        background: rgba(15, 15, 18, 0.95);
        border-right: 1px solid var(--glass-border);
        padding: 2rem;
        display: flex;
        flex-direction: column;
      }
      .sidebar .logo {
        margin-bottom: 3rem;
        font-size: 1.5rem;
      }
      .sidebar a {
        color: #ccc;
        text-decoration: none;
        padding: 1rem;
        margin-bottom: 0.5rem;
        border-radius: 10px;
      }
      .sidebar a.active,
      .sidebar a:hover {
        background: rgba(255, 71, 87, 0.1);
        color: var(--primary);
      }
      .main-content {
        flex: 1;
        padding: 2rem;
        overflow-y: auto;
      }
      .admin-btn {
        padding: 0.8rem 1.5rem;
        background: var(--primary);
        border: none;
        color: white;
        border-radius: 8px;
        cursor: pointer;
      }
      .product-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 2rem;
      }
      .product-table th {
        text-align: left;
        padding: 1rem;
        border-bottom: 1px solid var(--glass-border);
        color: #aaa;
      }
      .product-table td {
        padding: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2000;
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: #1e272e;
        padding: 2rem;
        border-radius: 16px;
        width: 500px;
      }
      .form-group {
        margin-bottom: 1rem;
      }
      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
      }
      .form-input {
        width: 100%;
        padding: 0.8rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid #333;
        color: white;
        border-radius: 8px;
      }
      
      /* Styling cho select dropdown */
      .form-input select,
      select.form-input {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        cursor: pointer;
      }
      
      /* Styling cho các option trong dropdown */
      .form-input option,
      select.form-input option {
        background: #2c3e50;
        color: white;
        padding: 0.5rem;
      }
      
      /* Hover effect cho option */
      .form-input option:hover,
      select.form-input option:hover {
        background: #34495e;
      }
    </style>
  </head>
  <body>
    <div class="admin-container">
      <aside class="sidebar">
        <div class="logo">Admin Panel</div>
        <a href="index.html"><i class="fas fa-home"></i> Dashboard</a>
        <a href="products.html" class="active"
          ><i class="fas fa-box"></i> Sản phẩm</a
        >
        <a href="orders.html"><i class="fas fa-shopping-bag"></i> Đơn hàng</a>
        <a href="#" onclick="logout()"
          ><i class="fas fa-sign-out-alt"></i> Đăng xuất</a
        >
      </aside>

      <main class="main-content">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
          "
        >
          <h1>Danh sách sản phẩm</h1>
          <button class="admin-btn" onclick="openModal()">
            + Thêm món mới
          </button>
        </div>
        
        <!-- Filter Section -->
        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
          <input 
            type="text" 
            id="search-input" 
            placeholder="Tìm kiếm sản phẩm..." 
            style="flex: 1; min-width: 200px; padding: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 8px; color: white;"
            oninput="debounceSearch(this.value)"
          />
          <select 
            id="category-filter" 
            class="form-input" 
            style="width: 200px; padding: 0.8rem;"
            onchange="filterByCategory(this.value)"
          >
            <option value="">Tất cả danh mục</option>
            <!-- Categories will be loaded dynamically -->
          </select>
          <button 
            class="admin-btn" 
            onclick="resetFilters()"
            style="padding: 0.8rem 1.5rem; background: rgba(255,255,255,0.1);"
          >
            <i class="fas fa-redo"></i> Đặt lại
          </button>
        </div>

        <table class="product-table">
          <thead>
            <tr>
              <th>STT</th>
              <th>Ảnh</th>
              <th>Tên</th>
              <th>Giá</th>
              <th>Hành động</th>
            </tr>
          </thead>
          <tbody id="product-list">
            <!-- Hiển thị bởi JS -->
          </tbody>
        </table>
      </main>
    </div>

    <!-- Modal -->
    <div id="productModal" class="modal">
      <div class="modal-content glass-card">
        <h2 id="modal-title" style="margin-bottom: 1.5rem">Thêm Sản Phẩm</h2>
        <form id="add-product-form">
          <input type="hidden" id="product-id" value="">
          <div class="form-group">
            <label>Tên sản phẩm</label>
            <input type="text" id="product-name" name="name" class="form-input" required />
          </div>
          <div class="form-group">
            <label>Danh mục</label>
            <select id="category" name="category_id" class="form-input" required>
              <!-- Categories will be loaded dynamically -->
            </select>
          </div>
          <div class="form-group">
            <label>Giá</label>
            <input type="number" id="price" name="price" class="form-input" required />
          </div>
          <div class="form-group">
            <label>Hình ảnh</label>
            <input
              type="file"
              name="image"
              class="form-input"
              accept="image/*"
              onchange="previewImage(this)"
            />
            <img
              id="img-preview"
              src="#"
              alt="Preview"
              style="
                display: none;
                margin-top: 10px;
                max-width: 100px;
                border-radius: 8px;
              "
            />
          </div>
          <div style="display: flex; gap: 1rem; margin-top: 1.5rem">
            <button
              type="button"
              class="admin-btn"
              style="background: #333"
              onclick="closeModal()"
            >
              Hủy
            </button>
            <button type="submit" class="admin-btn">Lưu sản phẩm</button>
          </div>
        </form>
      </div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script>
      // Helper to get user/token from both storages
      function getUser() {
        const userStr =
          localStorage.getItem("user") || sessionStorage.getItem("user");
        return userStr ? JSON.parse(userStr) : null;
      }
      function getToken() {
        return localStorage.getItem("token") || sessionStorage.getItem("token");
      }

      const user = getUser();
      const token = getToken(); // Use helper
      // Use relative path for redirect
      if (!user || user.role !== "admin")
        window.location.href = "/admin/login.html";

      function logout() {
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = "/admin/login.html";
      }

      const modal = document.getElementById("productModal");
      function openModal() {
        modal.style.display = "flex";
      }
      function closeModal() {
        modal.style.display = "none";
        document.getElementById("add-product-form").reset();
        document.getElementById("product-id").value = "";
        document.getElementById("modal-title").textContent = "Thêm Sản Phẩm";
        document.getElementById("img-preview").style.display = "none";
      }

      function previewImage(input) {
        const preview = document.getElementById("img-preview");
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            preview.src = e.target.result;
            preview.style.display = "block";
          };
          reader.readAsDataURL(input.files[0]);
        } else {
          preview.style.display = "none";
        }
      }

      // Chỉnh sửa sản phẩm
      let productsData = []; // Store products for editing
      let currentPage = 1;
      let totalPages = 1;
      const productsPerPage = 10;
      let currentCategory = '';
      let currentSearch = '';
      
      async function loadProducts(page = 1) {
        currentPage = page;
        let url = `/products?page=${page}&limit=${productsPerPage}`;
        
        if (currentCategory) {
          url += `&category=${currentCategory}`;
        }
        if (currentSearch) {
          url += `&search=${encodeURIComponent(currentSearch)}`;
        }
        
        const response = await API.get(url);
        const products = response.data || response || [];
        const pagination = response.pagination || null;
        
        if (pagination) {
          totalPages = pagination.totalPages;
        }
        
        productsData = products; // Store for later use
        const tbody = document.getElementById("product-list");

        const formatter = new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        });

        if (products.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 2rem; color: #aaa;">Không tìm thấy sản phẩm nào</td></tr>';
          renderPagination();
          return;
        }

        tbody.innerHTML = products
          .map(
            (p, index) => {
              const stt = (currentPage - 1) * productsPerPage + index + 1;
              return `
                <tr>
                    <td style="font-weight: 500; color: #aaa;">${stt}</td>
                    <td><img src="${
                      p.image_url || "https://via.placeholder.com/50"
                    }" width="50" height="50" style="object-fit:cover; border-radius:8px;"></td>
                    <td>${p.name}</td>
                    <td>${formatter.format(p.price)}</td>
                    <td>
                        <button onclick="editProduct(${p.id})" style="color: #ffa502; background:none; border:none; cursor:pointer; margin-right: 10px;" title="Chỉnh sửa">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteProduct(${p.id})" style="color: #ff4757; background:none; border:none; cursor:pointer;" title="Xóa">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            }
          )
          .join("");
          
        renderPagination();
      }
      
      function renderPagination() {
        let container = document.getElementById('admin-pagination');
        if (!container) {
          container = document.createElement('div');
          container.id = 'admin-pagination';
          container.style.cssText = 'display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 2rem; flex-wrap: wrap;';
          const table = document.querySelector('.product-table');
          if (table && table.parentElement) {
            table.parentElement.appendChild(container);
          }
        }
        
        if (totalPages <= 1) {
          container.innerHTML = '';
          return;
        }
        
        let html = '';
        html += `<button ${currentPage <= 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})" style="padding: 0.5rem 1rem; background: ${currentPage <= 1 ? 'rgba(255,255,255,0.05)' : 'var(--primary)'}; border: 1px solid var(--glass-border); border-radius: 8px; color: white; cursor: ${currentPage <= 1 ? 'not-allowed' : 'pointer'};">
          <i class="fas fa-chevron-left"></i>
        </button>`;
        
        for (let i = 1; i <= totalPages; i++) {
          if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `<button onclick="changePage(${i})" style="padding: 0.5rem 1rem; background: ${i === currentPage ? 'var(--primary)' : 'rgba(255,255,255,0.05)'}; border: 1px solid var(--glass-border); border-radius: 8px; color: white; cursor: pointer; font-weight: ${i === currentPage ? '600' : '400'};">${i}</button>`;
          } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += `<span style="color: #aaa;">...</span>`;
          }
        }
        
        html += `<button ${currentPage >= totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})" style="padding: 0.5rem 1rem; background: ${currentPage >= totalPages ? 'rgba(255,255,255,0.05)' : 'var(--primary)'}; border: 1px solid var(--glass-border); border-radius: 8px; color: white; cursor: ${currentPage >= totalPages ? 'not-allowed' : 'pointer'};">
          <i class="fas fa-chevron-right"></i>
        </button>`;
        
        container.innerHTML = html;
      }
      
      window.changePage = function(page) {
        loadProducts(page);
      }
      
      window.filterByCategory = function(category) {
        currentCategory = category;
        currentPage = 1;
        loadProducts(1);
      }
      
      window.searchProducts = function(query) {
        currentSearch = query;
        currentPage = 1;
        loadProducts(1);
      }
      
      let searchTimeout;
      window.debounceSearch = function(value) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          searchProducts(value);
        }, 500);
      }
      
      window.resetFilters = function() {
        currentCategory = '';
        currentSearch = '';
        currentPage = 1;
        document.getElementById('search-input').value = '';
        document.getElementById('category-filter').value = '';
        loadProducts(1);
      }
      
      // Load categories for filter and form
      async function loadCategories() {
        try {
          const token = getToken();
          const categories = await API.get('/admin/categories', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (categories && categories.length > 0) {
            // Populate filter dropdown
            const filterSelect = document.getElementById('category-filter');
            categories.forEach(cat => {
              const option = document.createElement('option');
              option.value = cat.id;
              option.textContent = cat.name;
              filterSelect.appendChild(option);
            });
            
            // Populate form dropdown
            const formSelect = document.getElementById('category');
            categories.forEach(cat => {
              const option = document.createElement('option');
              option.value = cat.id;
              option.textContent = cat.name;
              formSelect.appendChild(option);
            });
          }
        } catch (error) {
          console.error('Error loading categories:', error);
          showToast('Lỗi khi tải danh mục', 'error');
        }
      }

      function editProduct(id) {
        const product = productsData.find(p => p.id === id);
        if (!product) return;
        
        // Populate form
        document.getElementById("product-id").value = product.id;
        document.getElementById("product-name").value = product.name;
        document.getElementById("category").value = product.category_id || "";
        document.getElementById("price").value = product.price;
        
        // Show existing image
        if (product.image_url) {
          const preview = document.getElementById("img-preview");
          preview.src = product.image_url;
          preview.style.display = "block";
        }
        
        // Update modal title
        document.getElementById("modal-title").textContent = "Sửa Sản Phẩm";
        
        // Show modal
        modal.style.display = "flex";
      }

      // Thêm/Sửa sản phẩm
      document
        .getElementById("add-product-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const productId = document.getElementById("product-id").value;
          const isEditing = productId !== "";

          try {
            let res;
            if (isEditing) {
              // Update existing product
              res = await fetch(`/api/products/${productId}`, {
                method: "PUT",
                headers: { Authorization: `Bearer ${token}` },
                body: formData,
              });
            } else {
              // Create new product
              res = await fetch("/api/products", {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` },
                body: formData,
              });
            }
            
            if (res.ok) {
              showToast(isEditing ? "Cập nhật sản phẩm thành công!" : "Thêm sản phẩm thành công!", "success");
              closeModal();
              loadProducts();
            } else {
              const d = await res.json();
              showToast(d.message || (isEditing ? "Lỗi cập nhật sản phẩm" : "Lỗi thêm sản phẩm"), "error");
            }
          } catch (err) {
            console.error(err);
            showToast("Lỗi kết nối", "error");
          }
        });

      async function deleteProduct(id) {
        const performDelete = async () => {
          try {
            const res = await fetch(`/api/products/${id}`, {
              method: "DELETE",
              headers: { Authorization: `Bearer ${token}` },
            });
            
            if (res.ok) {
              showToast("Xóa sản phẩm thành công!", "success");
              loadProducts();
            } else {
              showToast("Lỗi khi xóa sản phẩm", "error");
            }
          } catch (err) {
            console.error(err);
            showToast("Lỗi kết nối", "error");
          }
        };
        
        showConfirm("Bạn có chắc chắn muốn xóa sản phẩm này?", performDelete);
      }

      loadCategories(); // Load categories first
      loadProducts();
    </script>
  </body>
</html>
